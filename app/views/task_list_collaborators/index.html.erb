<% content_for :title, "Colaboradores - #{@task_list.name}" %>

<div class="container py-4" style="max-width: 1100px;">

  <div class="card shadow-sm border-0 mb-4" style="border-left:.4rem solid <%= @task_list.color %>;">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between gap-3">
      <div>
        <h1 class="h4 mb-1 d-flex align-items-center gap-2">üë• Colaboradores</h1>
        <div class="text-muted small">
          üìã <%= link_to @task_list.name, task_list_path(@task_list), class: "text-decoration-none fw-semibold", style: "color: #{@task_list.color}" %>
        </div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <%= link_to "‚Ü©Ô∏è Voltar √† Lista", task_list_path(@task_list), class: "btn btn-outline-secondary d-inline-flex align-items-center" %>
        <% if @task_list.can_manage_collaborators?(current_user) && @users_to_invite.present? %>
          <%= link_to "‚ûï Convidar", new_task_list_task_list_collaborator_path(@task_list), class: "btn btn-primary d-inline-flex align-items-center" %>
        <% end %>
      </div>
    </div>

    <% accepted = @accepted_collaborators || [] %>
    <% pending  = @pending_collaborators  || [] %>

    <div class="card-body border-top pt-3">
      <div class="row text-center g-3">
        <div class="col-6 col-md-3">
          <div class="fw-bold fs-4 text-success"><%= accepted.count %></div>
          <div class="text-muted small">Ativos</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="fw-bold fs-4 text-warning"><%= pending.count %></div>
          <div class="text-muted small">Pendentes</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="fw-bold fs-4 text-info"><%= @task_list.tasks.count %></div>
          <div class="text-muted small">Tarefas</div>
        </div>
        <div class="col-6 col-md-3">
          <div class="fw-bold fs-4 text-purple"><%= accepted.count + pending.count %></div>
          <div class="text-muted small">Total convites</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Propriet√°rio -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-light fw-semibold small">Propriet√°rio</div>
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row justify-content-between gap-3 align-items-start">
        <div>
          <div class="fw-semibold">üëë <%= user_display_name(@task_list.user) %></div>
          <div class="text-muted small">üìß <%= @task_list.user.email %></div>
          <span class="badge text-bg-purple mt-2">Propriet√°rio</span>
        </div>
        <div class="text-muted small">
          Criada em <%= l(@task_list.created_at.to_date) %>
        </div>
      </div>
    </div>
  </div>

  <!-- Colaboradores Ativos -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">‚úÖ Colaboradores Ativos (<%= accepted.count %>)</span>
    </div>
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Usu√°rio</th>
            <th class="d-none d-md-table-cell">Email</th>
            <th>Permiss√£o</th>
            <th class="d-none d-lg-table-cell">Convidado por</th>
            <th class="d-none d-lg-table-cell">Aceito em</th>
            <th class="text-end">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <% if accepted.any? %>
            <% accepted.each do |c| %>
              <tr>
                <td class="fw-medium"><%= user_display_name(c.user) %></td>
                <td class="text-muted small d-none d-md-table-cell"><%= c.user.email %></td>
                <td>
                  <span class="badge <%= c.admin? ? 'text-bg-danger' : c.editor? ? 'text-bg-warning text-dark' : 'text-bg-secondary' %>">
                    <%= c.permission_name %>
                  </span>
                </td>
                <td class="small text-muted d-none d-lg-table-cell"><%= user_display_name(c.invited_by) %></td>
                <td class="small text-muted d-none d-lg-table-cell"><%= l(c.updated_at, format: :short) %></td>
                <td class="text-end">
                  <div class="d-inline-flex gap-2 align-items-center">
                    <% if @task_list.can_manage_collaborators?(current_user) %>
                      <%= form_with model: [@task_list, c], method: :patch, class: "d-flex gap-2 align-items-center", local: true do |f| %>
                        <%= f.select :permission_level,
                                      [["Visualizador","viewer"],["Editor","editor"],["Administrador","admin"]],
                                      {},
                                      class: "form-select form-select-sm" %>
                        <%= f.submit "Salvar", class: "btn btn-sm btn-outline-primary d-inline-flex align-items-center" %>
                      <% end %>
                      <%= button_to "Remover",
                            task_list_task_list_collaborator_path(@task_list, c),
                            method: :delete,
                            form: { data: { confirm_modal: "Remover #{user_display_name(c.user)} desta lista?" }, class: "d-inline" },
                            class: "btn btn-sm btn-danger d-inline-flex align-items-center" %>
                    <% else %>
                      <span class="text-muted small">Sem a√ß√µes</span>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="6" class="text-center text-muted py-4">Nenhum colaborador ativo ainda.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Convites Pendentes -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">‚è≥ Convites Pendentes (<%= pending.count %>)</span>
    </div>
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Usu√°rio</th>
            <th class="d-none d-md-table-cell">Email</th>
            <th>Permiss√£o</th>
            <th class="d-none d-lg-table-cell">Convidado por</th>
            <th class="d-none d-lg-table-cell">Enviado em</th>
            <th class="text-end">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <% if pending.any? %>
            <% pending.each do |c| %>
              <tr>
                <td class="fw-medium"><%= user_display_name(c.user) %></td>
                <td class="text-muted small d-none d-md-table-cell"><%= c.user.email %></td>
                <td><span class="badge text-bg-info"><%= c.permission_name %></span></td>
                <td class="small text-muted d-none d-lg-table-cell"><%= user_display_name(c.invited_by) %></td>
                <td class="small text-muted d-none d-lg-table-cell"><%= l(c.invited_at, format: :short) %></td>
                <td class="text-end">
                  <div class="d-inline-flex gap-2">
                    <% if current_user.id == c.user_id %>
                      <%= button_to "Aceitar",
                            accept_task_list_task_list_collaborator_path(@task_list, c),
                            method: :patch,
                            class: "btn btn-sm btn-success d-inline-flex align-items-center" %>
                      <%= button_to "Recusar",
                            decline_task_list_task_list_collaborator_path(@task_list, c),
                            method: :patch,
                            class: "btn btn-sm btn-outline-secondary d-inline-flex align-items-center" %>
                    <% end %>
                    <% if @task_list.can_manage_collaborators?(current_user) %>
                      <%= button_to "Cancelar",
                            task_list_task_list_collaborator_path(@task_list, c),
                            method: :delete,
                            form: { data: { confirm_modal: "Cancelar convite para #{user_display_name(c.user)}?" }, class: "d-inline" },
                            class: "btn btn-sm btn-danger d-inline-flex align-items-center" %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="6" class="text-center text-muted py-4">Nenhum convite pendente.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <% if @users_to_invite.blank? %>
    <div class="alert alert-light border text-center small">
      Todos os usu√°rios j√° foram convidados para esta lista.
    </div>
  <% end %>
</div>

<style>
  .text-purple { color:#6f42c1 !important; }
  .badge.text-bg-purple { background:#6f42c1 !important; }
</style>
