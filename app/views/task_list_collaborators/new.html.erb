<% content_for :title, "Convidar Colaborador - #{@task_list.name}" %>

<div class="container py-5" style="max-width: 720px;">
  <div class="text-center mb-4">
    <h1 class="h4 mb-1">ğŸ‘¥ Convidar Colaborador</h1>
    <h2 class="h6 text-muted mb-0">
      ğŸ“‹ <%= link_to @task_list.name, task_list_path(@task_list), style: "color: #{@task_list.color}; text-decoration: none;" %>
    </h2>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <%= form_with model: [@task_list, @task_list_collaborator], url: task_list_task_list_collaborators_path(@task_list), local: true do |form| %>
        <% if @task_list_collaborator.errors.any? %>
          <div class="alert alert-danger">
            <h6 class="mb-2">âŒ <%= pluralize(@task_list_collaborator.errors.count, "erro") %> impediram o envio:</h6>
            <ul class="mb-0">
              <% @task_list_collaborator.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <!-- SeleÃ§Ã£o de UsuÃ¡rio -->
        <div class="mb-3">
          <%= form.label :user_id, "ğŸ‘¤ Selecionar UsuÃ¡rio", class: "form-label fw-semibold" %>
          <% if defined?(@users) && @users.any? %>
            <%= form.collection_select :user_id, @users, :id, :email,
                  { prompt: "Escolha um usuÃ¡rio para convidar..." },
                  { class: "form-select" } %>
            <div class="form-text">Selecione um usuÃ¡rio existente OU informe um e-mail abaixo.</div>
          <% else %>
            <div class="alert alert-info mb-2">NÃ£o hÃ¡ usuÃ¡rios listados. Convide por e-mail abaixo.</div>
          <% end %>
        </div>

        <!-- Convite por e-mail -->
        <div class="mb-4">
          <label class="form-label fw-semibold">Ou convide por e-mail</label>
          <%= text_field_tag "task_list_collaborator[email]", nil,
                class: "form-control", placeholder: "usuario@exemplo.com" %>
          <div class="form-text">Se informado, o sistema tentarÃ¡ encontrar o usuÃ¡rio por e-mail.</div>
        </div>

        <!-- NÃ­vel de PermissÃ£o -->
        <div class="mb-4">
          <label class="form-label fw-semibold">ğŸ” NÃ­vel de PermissÃ£o</label>

          <div class="vstack gap-2">
            <label class="border rounded p-3 d-flex gap-3 align-items-start permission-option">
              <%= form.radio_button :permission_level, 'viewer',
                    checked: @task_list_collaborator.permission_level.blank? || @task_list_collaborator.permission_level == 'viewer',
                    class: "form-check-input mt-1" %>
              <div>
                <div class="fw-semibold">ğŸ‘ï¸ Visualizador</div>
                <small class="text-muted">Pode visualizar a lista e tarefas, sem editar.</small>
              </div>
            </label>

            <label class="border rounded p-3 d-flex gap-3 align-items-start permission-option">
              <%= form.radio_button :permission_level, 'editor',
                    checked: @task_list_collaborator.permission_level == 'editor',
                    class: "form-check-input mt-1" %>
              <div>
                <div class="fw-semibold">âœï¸ Editor</div>
                <small class="text-muted">Pode criar, editar e concluir tarefas, sem gerenciar colaboradores.</small>
              </div>
            </label>

            <label class="border rounded p-3 d-flex gap-3 align-items-start permission-option">
              <%= form.radio_button :permission_level, 'admin',
                    checked: @task_list_collaborator.permission_level == 'admin',
                    class: "form-check-input mt-1" %>
              <div>
                <div class="fw-semibold">ğŸ‘‘ Administrador</div>
                <small class="text-muted">Acesso total: tarefas e colaboradores.</small>
              </div>
            </label>
          </div>
        </div>

        <!-- Sobre a Lista -->
        <div class="bg-light rounded p-3 mb-4">
          <h3 class="h6 mb-3">ğŸ“Š Sobre esta Lista</h3>
          <div class="row text-center g-3">
            <div class="col-4">
              <div class="fw-bold text-primary fs-5"><%= @task_list.tasks.count %></div>
              <div class="text-muted small">Total</div>
            </div>
            <div class="col-4">
              <div class="fw-bold text-success fs-5"><%= @task_list.tasks.where(completed: true).count %></div>
              <div class="text-muted small">ConcluÃ­das</div>
            </div>
            <div class="col-4">
              <div class="fw-bold text-purple fs-5"><%= @task_list.collaborators.count %></div>
              <div class="text-muted small">Colaboradores</div>
            </div>
          </div>
        </div>

        <!-- AÃ§Ãµes -->
        <div class="d-flex justify-content-center gap-2">
          <%= link_to "ğŸš« Cancelar", task_list_task_list_collaborators_path(@task_list), class: "btn btn-outline-secondary" %>
          <%= form.submit "ğŸ“¨ Enviar Convite", class: "btn btn-primary" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', highlightPermission);
document.addEventListener('DOMContentLoaded', highlightPermission);

function highlightPermission() {
  const options = document.querySelectorAll('.permission-option');
  options.forEach(opt => {
    const input = opt.querySelector('input[type="radio"]');
    const sync = () => {
      if (input.checked) {
        opt.classList.add('border-primary','bg-light');
      } else {
        opt.classList.remove('border-primary','bg-light');
      }
    };
    input.addEventListener('change', () => {
      options.forEach(o => o.classList.remove('border-primary','bg-light'));
      sync();
    });
    sync();
    opt.addEventListener('click', (e) => {
      if (e.target !== input) input.checked = true;
      input.dispatchEvent(new Event('change', { bubbles: true }));
    });
  });
}
</script>
